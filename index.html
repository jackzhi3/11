<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单合约交互界面</title>
    <!-- 引入Bootstrap CSS 用于简单样式，可选 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Web3.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        body { padding: 20px; }
        #status { margin-top: 10px; min-height: 24px; }
        .hidden { display: none; }
    </style>
</head>
<body class="container">
    <h1 class="my-4">简单合约交互页面</h1>

    <!-- 连接钱包按钮 -->
    <button id="connectWallet" class="btn btn-primary mb-3">连接钱包</button>
    <p>当前连接账户: <span id="connectedAccount">未连接</span></p>

    <hr>

    <!-- 显示合约余额 -->
    <div>
        <h4>合约余额查询</h4>
        <button id="getBalance" class="btn btn-info" disabled>获取合约余额</button>
        <p>合约余额: <span id="contractBalance">0</span> ETH</p>
    </div>

    <hr>

    <!-- 向合约转账 -->
    <div>
        <h4>向合约转账</h4>
        <div class="mb-3">
            <label for="amount" class="form-label">转账金额 (ETH):</label>
            <input type="number" step="0.001" class="form-control" id="amount" placeholder="例如: 0.1">
        </div>
        <button id="transferToContract" class="btn btn-success" disabled>转账</button>
        <div id="status" class="mt-3"></div> <!-- 用于显示交易状态 -->
    </div>

    <script>
        // 请替换为你的合约地址和ABI
        const contractAddress = '0x24efAcbc1a5420eb4edE48c39a1BaaDD22122bC9'; // 例如 '0x1234...'
        const contractABI = [
	{
		"inputs": [],
		"stateMutability": "payable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "Received",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "getBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	}
];

        let web3;
        let contractInstance;
        let userAccount;

        // 页面加载完成后执行
        window.addEventListener('load', async () => {
            // 检查是否安装了MetaMask
            if (typeof window.ethereum !== 'undefined') {
                // 创建Web3实例，使用MetaMask提供的provider
                web3 = new Web3(window.ethereum);
                // 创建合约实例
                contractInstance = new web3.eth.Contract(contractABI, contractAddress);

                // 监听连接钱包按钮点击事件
                document.getElementById('connectWallet').addEventListener('click', connectWallet);
                // 监听获取余额按钮点击事件
                document.getElementById('getBalance').addEventListener('click', getContractBalance);
                // 监听转账按钮点击事件
                document.getElementById('transferToContract').addEventListener('click', transferToContract);

            } else {
                alert('请安装MetaMask钱包！');
            }
        });

        // 连接钱包函数
        async function connectWallet() {
            try {
                // 请求用户授权连接账户
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                document.getElementById('connectedAccount').textContent = userAccount;
                // 连接成功后，启用获取余额和转账按钮
                document.getElementById('getBalance').disabled = false;
                document.getElementById('transferToContract').disabled = false;
                // 也可以默认获取一次余额
                await getContractBalance();
            } catch (error) {
                console.error("用户拒绝连接或连接失败:", error);
                alert('连接钱包失败，请重试或检查MetaMask。');
            }
        }

        // 获取合约余额函数
        async function getContractBalance() {
            if (!contractInstance) return;
            try {
                // 调用合约的 getBalance 方法（假设你的合约有这个方法）
                // 如果你的合约没有 getBalance，可以使用 web3.eth.getBalance(contractAddress)
                const balance = await contractInstance.methods.getBalance().call();
                // 将余额从Wei转换为ETH，并显示（假设getBalance返回的是uint256，单位为Wei）
                const balanceInEth = web3.utils.fromWei(balance, 'ether');
                document.getElementById('contractBalance').textContent = balanceInEth;
            } catch (error) {
                console.error("获取合约余额失败:", error);
                alert('获取合约余额失败，请检查合约地址和ABI是否正确，以及网络是否匹配。');
            }
        }

        // 向合约转账函数
        async function transferToContract() {
            if (!web3 || !userAccount) {
                alert('请先连接钱包！');
                return;
            }
            const amountInput = document.getElementById('amount').value;
            if (!amountInput || amountInput <= 0) {
                alert('请输入有效的转账金额！');
                return;
            }

            const amountInWei = web3.utils.toWei(amountInput, 'ether');
            const statusDiv = document.getElementById('status');

            try {
                statusDiv.textContent = '交易处理中，请等待...';
                statusDiv.className = 'alert alert-info';

                // 发送交易：直接向合约地址转账ETH
                // 注意：这将会触发合约的 receive() 或 fallback() 函数
                const receipt = await web3.eth.sendTransaction({
                    from: userAccount,
                    to: contractAddress, // 直接发送到合约地址
                    value: amountInWei,
                    gas: 300000, // 设置足够的Gas Limit，复杂的合约操作可能需要更多Gas
                });

                statusDiv.textContent = `转账成功！交易哈希: ${receipt.transactionHash}`;
                statusDiv.className = 'alert alert-success';

                // 转账成功后，更新合约余额显示
                await getContractBalance();
                // 清空输入框
                document.getElementById('amount').value = '';

            } catch (error) {
                console.error("转账失败:", error);
                let errorMsg = '转账失败！';
                if (error.message) {
                    errorMsg += ` 原因: ${error.message}`;
                }
                statusDiv.textContent = errorMsg;
                statusDiv.className = 'alert alert-danger';
            }
        }

    </script>
</body>
</html>
